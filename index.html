<!doctype html>
<html>
  <head>
  <title>Jars</title>
  <script src="./js/jquery.min.js"></script>
  <script src="./jspsych-6/jspsych.js"></script>
  <script src="./jspsych-6/plugins/jspsych-survey-multi-choice.js"></script>
	<script src="./jspsych-6/plugins/jspsych-html-button-response.js"></script>
	<script src="./jspsych-6/plugins/jspsych-image-button-response.js"></script>
  <script src="./jspsych-6/plugins/jspsych-survey-text.js"></script>
  <script src="./jspsych-6/plugins/jspsych-survey-text-time.js"></script>
	<script src="./js/welcome.js"></script>
  <link href="./jspsych-6/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>

  <body>
	  <div id="welcome"></div>
  </body>

  <script>

/////////////////////////////// EXPERIMENT 13 ///////////////////////////////////////
// re-inviting expt. 9 and 11 participants to complete an individual differences battery
////////////////////////////////////////////////////////////////////////////////////

// initialise timeline
var timeline = [];
var beast = [];

// // if participants get an instruction check question wrong, they will loop back to the previous instruction page
var introloop = [];

// generate a random turkcode
var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString();
var pid = Math.floor(Math.random() * 100000);
var filename = "urns-expt13" + pid + "_turkcode_" + turkcode;

// randomise variables
// to determine earnings in the BEAST
// 1. randomly select a round (from 0-5)
var randRound = Math.round(Math.random() * (4-0) + 0);

// 2. randomly select estimate A or B
// var noEstimates = ['A', 'B'];
var noEstimates = 'A';
var randEstimate = jsPsych.randomization.sampleWithoutReplacement(noEstimates, 1);

// if (randEstimate == 'A') {
//   var selectedEstimates = estimatesA;
// } else {
//   var selectedEstimates = estimatesB;
// };
// console.log(selectedEstimates);

// // specify images to preload
// var images = ['img/closeddoor.jpg', 'img/redjar.png', 'img/bluejar.png','img/greyball.PNG',
//               'img/redball.PNG', 'img/blueball.PNG', 'img/attnCheck.JPG', 'img/scale-based-on-balls.JPG', 'img/scale-based-on-guesses.jpg', 'img/scale-based-on-balls-and-guesses.jpg'];
// jsPsych.pluginAPI.preloadImages(images);

// --------------------------- Randomise variables ---------------------------- //

// ------------ save data to unsw server ----------------------- //
function saveData(name, data){
  	var xhr = new XMLHttpRequest();
  	xhr.open('POST', 'save_data.php'); // 'write_data.php' is the path to the php file described above.
  	xhr.setRequestHeader('Content-Type', 'application/json');
  	xhr.send(JSON.stringify({filename: filename, filedata: data})); //specify a variable "filename"
  };

/* function to start the jsPsych experiment */
function startExperiment(){

  jsPsych.data.addProperties({  // record these variables in the jsPsych data
    turkcode: turkcode

  });

  jsPsych.init({
    timeline: timeline,
    // preload_images: images,
    // on_trial_finish: function(data){saveData(filename, jsPsych.data.get().csv())},  // use for UNSW server - uncomment to locally save data file as csv
    on_finish: function() {
      jsPsych.data.displayData('csv');
      endExperiment( jsPsych.data.get().csv(), function() { document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-size:120%; width:800px; float:right"><p><br><br><br>All done!<br><br>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + '</span>. To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. Please contact us if something goes wrong and we\'ll fix it as quickly as possible.</p></div></div>') })
    }
  });
};

/* save and finish */
function endExperiment(dataset,callback) {
 // $.post('submit',{"content": dataset}); // uncomment to post data to google cloud
 setTimeout(callback,1000)
};

/* change the display property of a set of objects */
function setDisplay(theClass, theValue) {
 var i, classElements = document.getElementsByClassName(theClass);
 for (i = 0; i < classElements.length; i = i + 1) {
  classElements[i].style.display = theValue;
 }
};

// -------------------------- INSTRUCTIONS ----------------------------- //

var instructionsPreempt = {
  type: 'html-button-response',
  timing_post_trial: 0,
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Click here to begin'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 70)},
  is_html: true,
  stimulus: "The experiment will begin now.<br><br>The first few pages will show the instructions.<br>Make sure to read them carefully, as you will be asked questions to check that you understand them." +
  "<br><br>If you answer a question incorrectly, you will be taken back to the instructions page.<br><br>"
};
// timeline.push(instructionsPreempt);

// ----------------- BEAST ------------- //

// 1. welcome
var beastImgHeight = 400;

// 2. Instructions - points depend on accuracy of estimates
var beastInsts1 = {
  type: 'html-button-response',
  timing_post_trial: 0,
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Click here to begin'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 30)},
  is_html: true,
  stimulus: "In this task, you have to make a number of estimates.<br><br>" +
    "The number of Points you earn in this task depends on <i>how accurate</i> your estimates are.<br><br>"
};
// timeline.push(beastInsts1);

// 3. Instrutions - explain 5 rounds of animal preloadImages
var beastInsts2 = {
  type: 'html-button-response',
  timing_post_trial: 0,
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Click here to begin'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 30)},
  is_html: true,
  stimulus: "<b>Instructions 1/3</b><br><br>This task consists of <b>5 rounds</b>.<br>" +
    "At the beginning of each round, you will observe an image showing a number of animals.<br><br>" +
    // "For example:<br><img src ='http://www.surveycamel.com/hively/animalPictures/ladybugs.JPG' height='50%'><br>" +
    "For example:<br><img src ='img/ladybugs.jpg' height='" + beastImgHeight + "px'><br>" +
    "The image will disappear after 6 seconds, upon which<br>" +
    "<b>you have to estimate how many animals were displayed.</b><br><br>" +
    "The more accurate your estimate, the more Points you can earn.<br>We explain this later.<br><br>"
};
introloop.push(beastInsts2);

// 4. Instructions - will make an estimate and receive an estimate
var beastInsts3 = {
  type: 'html-button-response',
  timing_post_trial: 0,
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Click here to begin'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 30)},
  is_html: true,
  stimulus: "<b>Instructions 2/3</b><br><br>" +
    "Once the image has disappeared, you have to enter your estimate of how many animals were displayed.<br>" +
    "You have to enter your estimate within <b>15 seconds</b>.<br>" +
    "This is your estimate for <b>part A</b> of a round.<br><br>" +
    "Once you have entered your estimate, <b>part B</b> of the round begins.<br>" +
    "You can observe the <i>part A estimate of another MTurker</i>.<br><br>" +
    "Over 100 MTurkers participated in a previous session in which they completed this task.<br>" +
    "In each round, you can observe the part A estimate of <b>ONE</b> of these previous MTurkers.<br>" +
    "The previous MTurkers saw the same image as you. They also saw it for 6 seconds.<br>" +
    "After the image disappeared, they also had to estimate how many animals were displayed.<br>" +
    "They could also earn a higher bonus if their estimate was more accurate.<br><br>" +
    "You then have to <b>enter a second estimate</b>.<br>" +
    "You can enter the same estimate as in part A, or adjust it as you wish.<br>" +
    "You have to enter your second estimate within <b>45 seconds</b>.<br>" +
    "This is your estimate for <b>part B</b> of a round.<br><br>" +
    "<i>Note: if you do not enter your estimate within the time limit, you will be removed from the HIT and we will not be able to pay you.</i><br>" +
    "Once you have entered your part B estimate, the round is over and a new round begins.<br><br>"
};
introloop.push(beastInsts3);

// 5. Instructions - how points work
// 100 points = $1 USD

var beastInsts3 = {
  type: 'html-button-response',
  timing_post_trial: 0,
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Click here to begin'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 30)},
  is_html: true,
  stimulus: "<b>Instructions 3/3</b><br><br><b>Your bonus earnings</b><br><br>" +
    "The more accurate your estimates, the more Points you can earn in this task.<br>" +
    "At the end of this HIT, the Points you earn are converted into your bonus earnings.<br>" +
    "Your bonus for this task is calculated as follows.<br><br>" +
    "Once you have completed this HIT, the computer will randomly select 1 of the 5 rounds of this task.<br>" +
    "Then the computer will randomly select part A or B.<br>" +
    "Your estimate for that part is used to calculate your earnings for this task.<br><br>" +
    "<b>If you estimated the number of animals <i>exactly right</i>, you earn 100 Points = $1.00.</b><br>" +
    "<b>For each number that you are off, we subtract 5 Points ($0.05).</b><br>" +
    "The number of Points you earn in this task cannot become negative.<br><br>" +
    "For example, if the actual number of animals in the image was 60, and your estimatation 53, you were 7 off.<br>" +
    "This would mean that we subtract 7 <i>x</i> 5 = 35 Points.<br>Your earnings for that estimate would be 100 - 35 = 65 Points = $0.65.<br><br>" +
    "Click 'Continue' if you understand your task.<br>A brief quiz will follow to check your understanding.<br><br>"
};
introloop.push(beastInsts3);

// 6. instructions check questions x 3
var instructAnswers = ["Correct", "Incorrect"];
var correctString1 = '{"estimate":"' + instructAnswers[0] + '","second":"' + instructAnswers[0] + '","points":"' + instructAnswers[0] + '"}'; // important that there are no spaces in this string
var instruct1Correct = false;

var instructQ1Check = {
  type: "survey-multi-choice",
  preamble: ["<p align='center'><b>Check for understanding</b></p>" +
    "To check your understanding of the task, please indicate for each of these statements whether they are correct or incorrect."],
  questions: [{prompt: "In each round of this task you will view an image. You have to estimate how many animals were displayed in it.",
                options: instructAnswers,
                name: "estimate",
                required: true},
              {prompt: "Once you have entered your estimate, you can observe the estimate of another MTurker who completed this task before." +
                        "You can then make a second estimate.",
                options: instructAnswers,
                name: "second",
                required: true},
              {prompt: "The more accurate your estimates, the more Points you can earn.",
                options: instructAnswers,
                name: "points",
                required: true}],
  on_finish: function(data) {
    if(data.responses == correctString1) {instruct1Correct = true;}
  }
};
introloop.push(instructQ1Check);

// define the splash screen shown if participants answer incorrectly
var splash_screen1 = {
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn">%choice%</button>',
  choices: ['Click here to read the instructions again'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 500)},
  is_html: true,
  stimulus: 'At least one of your answers was incorrect.'
};

// define an additional conditional that will only show the splash screen if the answer was wrong
var conditional_splash1 = {
  timeline: [splash_screen1],
  conditional_function: function(data) {return !instruct1Correct} // skip if correct
};
introloop.push(conditional_splash1);

// add the first instructions block + check question to a loop node
var loop_node = {
  timeline: introloop,
  loop_function: function(data) {return !instruct1Correct} // stop looping if correct
};
// timeline.push(loop_node);

// try without a loop

var animals = ['ants', 'bees', 'cranes', 'crickets', 'flamingos'];
var j;

var devs = [0.25, 0.15, 0.2, 0.15, 0.25];

var correctNos = [93, 78, 59, 74, 69];

/* estimates from previous session (without social information) */
var peersMat = [
    [20,24,25,30,33,35,35,38,40,42,43,45,45,46,48,50,50,50,50,52,55,55,56,56,57,60,60,60,60,62,64,64,64,65,65,65,65,67,67,69,69,70,70,70,70,70,70,70,70,70,72,72,72,74,75,75,75,75,75,75,75,75,76,78,80,80,80,80,80,80,80,84,85,85,85,85,85,86,89,89,90,90,95,98,100,100,100,120,120,120,120,120,125,126,130,155],
    [28,30,30,30,30,35,37,40,40,41,44,45,47,49,50,50,52,53,55,56,56,56,58,58,59,60,60,60,60,60,60,60,62,62,62,62,63,63,65,65,65,65,65,68,68,68,70,70,70,70,70,70,70,72,72,74,75,75,75,77,77,77,78,80,80,80,80,80,80,80,80,80,84,84,85,85,85,85,88,90,90,90,90,90,91,98,100,100,100,100,103,103,110,110,110,145],
    [18,30,30,30,30,34,35,35,35,38,40,40,40,40,42,44,45,45,45,45,45,45,45,48,48,48,48,48,49,50,50,50,50,50,50,50,50,50,51,51,52,52,52,52,54,54,55,55,55,55,55,55,55,55,56,56,58,59,60,60,60,60,60,60,60,64,64,65,65,65,65,65,65,65,65,65,66,66,68,70,70,75,75,75,75,79,80,80,81,86,86,88,89,95,100,101],
    [20,21,25,40,40,41,42,45,45,46,47,48,48,50,50,53,55,55,55,55,55,55,55,56,58,58,60,60,60,60,62,64,65,65,65,65,65,67,67,68,69,70,70,70,70,70,70,70,70,70,70,70,70,71,72,73,74,75,75,75,75,75,75,75,76,77,78,80,80,80,80,80,80,80,80,83,88,88,88,90,90,90,92,95,95,100,100,101,102,110,110,110,120,121,140,150],
    [23,25,28,30,32,33,33,34,35,38,40,40,40,40,40,41,42,42,45,45,47,48,49,50,50,50,50,53,53,54,55,55,55,55,55,55,55,55,56,57,57,58,58,59,60,60,60,60,60,60,60,60,60,62,62,62,62,62,65,65,65,65,65,65,65,66,66,66,66,68,68,69,70,70,70,70,72,72,73,75,75,75,76,77,80,80,80,84,85,85,90,92,102,110,125,140]
    ];

var lastA = 0;
var closest = 0;

var viewTime = 6000;

var preRound1 = {                   // 7. get ready - click to see an image
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "You have answered all control questions correctly.<br>The task starts now.<br><br>" +
    "When you click below, an image will appear showing a number of <b>" + animals[0] + "</b>.<br>" +
    "After <b>6 seconds</b>, the image disappears.<br>" +
    "A box will appear in which you have to estimate how many " + animals[0] + " there were.<br><br>" +
    "You have to enter your estimate <b>within 15 seconds</b>.<br><br>" +
    "Click below when you are ready.<br><br>"
};
// timeline.push(preRound1);

var viewImage1 = {        // 8. see image
  type: 'image-button-response',
  stimulus: 'img/' + animals[0] + '.jpg',
  stimulus_height: beastImgHeight,
  choices: ['Continue'],
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  stimulus_duration: viewTime,
  trial_duration: viewTime,
  response_ends_trial: false
};
// timeline.push(viewImage1);

var estimateA1 = {
  type: 'survey-text-time',
  questions: [{prompt: "How many " + animals[0] + " were shown in the image?",
                placeholder: "Number of " + animals[0],
                required: true}],
  preamble: "Round " + [0 + 1] + ": part A estimate",
  time_limit: 5000,
  on_finish:function(data) {
    lastA1 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastA1 = lastA1.substr(14,3);  // capture 3-digit numbers
    if (lastA1.slice(2) == '"') {lastA1 = lastA1.substr(0,2);}; // for 2-digit numbers
  },
};
beast.push(estimateA1);

var estimateB1 = {
  type: 'survey-text-time',
  questions: [{prompt:  "You can now enter your part B estimate below.",
                placeholder: "Number of " + animals[0],
                required: true}],
  preamble: function() {
    if (lastA1 < correctNos[0]) {var target = lastA1 * (1 + devs[0]);
      console.log("smaller");
    } else {
      if (lastA1 == correctNos[0]) {
        if (Math.random() < 0.5) {
          var target = lastA1 * (1 + devs[0]);
          }
      } else {
        var target = lastA1 * (1 - devs[0]);
        console.log("larger");
      }
    };
    console.log(target);

    closest = peersMat[0].reduce(function(prev, curr) {
      return(Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev);
    });

    return("Round " + [0 + 1] + ": part B estimate<br><br>" +
    "Your part A estimate of <b>" + lastA1 + "</b> has been recorded.<br><br>" +
    "Now, we show you the part A estimate of an MTurker who completed this task before.<br>" +
    "This previous MTurker saw the same image as you just did. They also saw it for 6 seconds.<br><br>" +
    "Their estimate was <b>" + closest + "</b>.")
    },

  on_finish:function(data) {
    lastB1 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastB1 = lastB1.substr(14,3);  // capture 3-digit numbers
    if (lastB1.slice(2) == '"') {lastB1 = lastB1.substr(0,2);}; // for 2-digit numbers
  },
  // time_limit: xx
};
beast.push(estimateB1);

// 11. flag end of round, continue next round, go back to 7, unless last round
var endRound1 = {                   // 2nd informant
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "Round completed<br><br>This is the end of round " + [0 + 1] + ".<br>" +
    "Click below to continue.<br><br>"
};
// beast.push(endRound1);

var preRound2 = {                   // 7. get ready - click to see an image
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "A new round starts now.<br><br>" +
    "When you click below, an image will appear showing a number of <b>" + animals[1] + "</b>.<br>" +
    "After <b>6 seconds</b>, the image disappears.<br>" +
    "A box will appear in which you have to estimate how many " + animals[1] + " there were.<br><br>" +
    "You have to enter your estimate <b>within 15 seconds</b>.<br><br>" +
    "Click below when you are ready.<br><br>"
};
// beast.push(preRound2);

var viewImage2 = {        // 8. see image
  type: 'image-button-response',
  stimulus: 'img/' + animals[1] + '.jpg',
  stimulus_height: beastImgHeight,
  choices: ['Continue'],
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  stimulus_duration: viewTime,
  trial_duration: viewTime,
  response_ends_trial: false
};
// beast.push(viewImage2);

var estimateA2 = {
  type: 'survey-text-time',
  questions: [{prompt: "How many " + animals[1] + " were shown in the image?",
                placeholder: "Number of " + animals[1],
                required: true}],
  preamble: "Round " + [1 + 1] + ": part A estimate",
  time_limit: 5000,
  on_finish:function(data) {
    lastA2 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastA2 = lastA2.substr(14,3);  // capture 3-digit numbers
    if (lastA2.slice(2) == '"') {lastA2 = lastA2.substr(0,2);}; // for 2-digit numbers
  },
};
beast.push(estimateA2);

var estimateB2 = {
  type: 'survey-text-time',
  questions: [{prompt:  "You can now enter your part B estimate below.",
                placeholder: "Number of " + animals[1],
                required: true}],
  preamble: function() {
    if (lastA2 < correctNos[1]) {
      var target = lastA2 * (1 + devs[1]);
    } else {
      if (lastA2 == correctNos[1]) {
        if (Math.random() < 0.5) {
          var target = lastA2 * (1 + devs[1]);
          }
      } else {
        var target = lastA2 * (1 - devs[1]);
      }
    };

    closest = peersMat[1].reduce(function(prev, curr) {
      return(Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev);
    });

    return("Round " + [1 + 1] + ": part B estimate<br><br>" +
    "Your part A estimate of <b>" + lastA2 + "</b> has been recorded.<br><br>" +
    "Now, we show you the part A estimate of an MTurker who completed this task before.<br>" +
    "This previous MTurker saw the same image as you just did. They also saw it for 6 seconds.<br><br>" +
    "Their estimate was <b>" + closest + "</b>.")
    },

  on_finish:function(data) {
    lastB2 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastB2 = lastB2.substr(14,3);  // capture 3-digit numbers
    if (lastB2.slice(2) == '"') {lastB2 = lastB2.substr(0,2);}; // for 2-digit numbers
  },
  // time_limit: xx
};
beast.push(estimateB2);

var endRound2 = {                   // 2nd informant
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "Round completed<br><br>This is the end of round " + [1 + 1] + ".<br>" +
    "Click below to continue.<br><br>"
};
// timeline.push(endRound2);

var preRound3 = {                   // 7. get ready - click to see an image
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "A new round starts now.<br><br>" +
    "When you click below, an image will appear showing a number of <b>" + animals[2] + "</b>.<br>" +
    "After <b>6 seconds</b>, the image disappears.<br>" +
    "A box will appear in which you have to estimate how many " + animals[2] + " there were.<br><br>" +
    "You have to enter your estimate <b>within 15 seconds</b>.<br><br>" +
    "Click below when you are ready.<br><br>"
};
// beast.push(preRound3);

var viewImage3 = {        // 8. see image
  type: 'image-button-response',
  stimulus: 'img/' + animals[2] + '.jpg',
  stimulus_height: beastImgHeight,
  choices: ['Continue'],
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  stimulus_duration: viewTime,
  trial_duration: viewTime,
  response_ends_trial: false
};
// beast.push(viewImage3);

var estimateA3 = {
  type: 'survey-text-time',
  questions: [{prompt: "How many " + animals[2] + " were shown in the image?",
                placeholder: "Number of " + animals[2],
                required: true}],
  preamble: "Round " + [2 + 1] + ": part A estimate",
  time_limit: 5000,
  on_finish:function(data) {
    lastA3 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastA3 = lastA3.substr(14,3);  // capture 3-digit numbers
    if (lastA3.slice(2) == '"') {lastA3 = lastA3.substr(0,2);}; // for 2-digit numbers
  },
};
beast.push(estimateA3);

var estimateB3 = {
  type: 'survey-text-time',
  questions: [{prompt:  "You can now enter your part B estimate below.",
                placeholder: "Number of " + animals[2],
                required: true}],
  preamble: function() {
    if (lastA3 < correctNos[2]) {
      var target = lastA3 * (1 + devs[2]);
    } else {
      if (lastA3 == correctNos[2]) {
        if (Math.random() < 0.5) {
          var target = lastA3 * (1 + devs[2]);
          }
      } else {
        var target = lastA3 * (1 - devs[2]);
      }
    };

    closest = peersMat[2].reduce(function(prev, curr) {
      return(Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev);
    });

    return("Round " + [2 + 1] + ": part B estimate<br><br>" +
    "Your part A estimate of <b>" + lastA3 + "</b> has been recorded.<br><br>" +
    "Now, we show you the part A estimate of an MTurker who completed this task before.<br>" +
    "This previous MTurker saw the same image as you just did. They also saw it for 6 seconds.<br><br>" +
    "Their estimate was <b>" + closest + "</b>.")
    },

  on_finish:function(data) {
    lastB3 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastB3 = lastB3.substr(14,3);  // capture 3-digit numbers
    if (lastB3.slice(2) == '"') {lastB3 = lastB3.substr(0,2);}; // for 2-digit numbers
  },
  // time_limit: xx
};
beast.push(estimateB3);

var endRound3 = {                   // 2nd informant
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "Round completed<br><br>This is the end of round " + [2 + 1] + ".<br>" +
    "Click below to continue.<br><br>"
};

// beast.push(endRound1);
var preRound4 = {                   // 7. get ready - click to see an image
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "A new round starts now.<br><br>" +
    "When you click below, an image will appear showing a number of <b>" + animals[3] + "</b>.<br>" +
    "After <b>6 seconds</b>, the image disappears.<br>" +
    "A box will appear in which you have to estimate how many " + animals[3] + " there were.<br><br>" +
    "You have to enter your estimate <b>within 15 seconds</b>.<br><br>" +
    "Click below when you are ready.<br><br>"
};
// beast.push(preRound4);

var viewImage4 = {        // 8. see image
  type: 'image-button-response',
  stimulus: 'img/' + animals[3] + '.jpg',
  stimulus_height: beastImgHeight,
  choices: ['Continue'],
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  stimulus_duration: viewTime,
  trial_duration: viewTime,
  response_ends_trial: false
};
// beast.push(viewImage4);

var estimateA4 = {
  type: 'survey-text-time',
  questions: [{prompt: "How many " + animals[3] + " were shown in the image?",
                placeholder: "Number of " + animals[3],
                required: true}],
  preamble: "Round " + [3 + 1] + ": part A estimate",
  time_limit: 5000,
  on_finish:function(data) {
    lastA4 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastA4 = lastA4.substr(14,3);  // capture 3-digit numbers
    if (lastA4.slice(2) == '"') {lastA4 = lastA4.substr(0,2);}; // for 2-digit numbers
  },
};
beast.push(estimateA4);

var estimateB4 = {
  type: 'survey-text-time',
  questions: [{prompt:  "You can now enter your part B estimate below.",
                placeholder: "Number of " + animals[3],
                required: true}],
  preamble: function() {
    if (lastA4 < correctNos[3]) {
      var target = lastA4 * (1 + devs[3]);
    } else {
      if (lastA4 == correctNos[3]) {
        if (Math.random() < 0.5) {
          var target = lastA4 * (1 + devs[3]);
          }
      } else {
        var target = lastA4 * (1 - devs[3]);
      }
    };
    closest = peersMat[3].reduce(function(prev, curr) {
      return(Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev);
    });

    return("Round " + [3 + 1] + ": part B estimate<br><br>" +
    "Your part A estimate of <b>" + lastA4 + "</b> has been recorded.<br><br>" +
    "Now, we show you the part A estimate of an MTurker who completed this task before.<br>" +
    "This previous MTurker saw the same image as you just did. They also saw it for 6 seconds.<br><br>" +
    "Their estimate was <b>" + closest + "</b>.")
    },

  on_finish:function(data) {
    lastB4 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastB4 = lastB4.substr(14,3);  // capture 3-digit numbers
    if (lastB4.slice(2) == '"') {lastB4 = lastB4.substr(0,2);}; // for 2-digit numbers
  },
  // time_limit: xx
};
beast.push(estimateB4);

var endRound4 = {                   // 2nd informant
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "Round completed<br><br>This is the end of round " + [3 + 1] + ".<br>" +
    "Click below to continue.<br><br>"
};
// beast.push(endRound1);

var preRound5 = {                   // 7. get ready - click to see an image
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "A new round starts now.<br><br>" +
    "When you click below, an image will appear showing a number of <b>" + animals[4] + "</b>.<br>" +
    "After <b>6 seconds</b>, the image disappears.<br>" +
    "A box will appear in which you have to estimate how many " + animals[4] + " there were.<br><br>" +
    "You have to enter your estimate <b>within 15 seconds</b>.<br><br>" +
    "Click below when you are ready.<br><br>"
};
// beast.push(preRound5);

var viewImage5 = {        // 8. see image
  type: 'image-button-response',
  stimulus: 'img/' + animals[4] + '.jpg',
  stimulus_height: beastImgHeight,
  choices: ['Continue'],
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  stimulus_duration: viewTime,
  trial_duration: viewTime,
  response_ends_trial: false
};
// beast.push(viewImage5);

var estimateA5 = {
  type: 'survey-text-time',
  questions: [{prompt: "How many " + animals[4] + " were shown in the image?",
                placeholder: "Number of " + animals[4],
                required: true}],
  preamble: "Round " + [4 + 1] + ": part A estimate",
  time_limit: 5000,
  on_finish:function(data) {
    lastA5 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastA5 = lastA5.substr(14,3);  // capture 3-digit numbers
    if (lastA5.slice(2) == '"') {lastA5 = lastA5.substr(0,2);}; // for 2-digit numbers
  },
};
beast.push(estimateA5);

var estimateB5 = {
  type: 'survey-text-time',
  questions: [{prompt:  "You can now enter your part B estimate below.",
                placeholder: "Number of " + animals[4],
                required: true}],
  preamble: function() {
    if (lastA5 < correctNos[4]) {
      var target = lastA5 * (1 + devs[4]);
    } else {
      if (lastA5 == correctNos[4]) {
        if (Math.random() < 0.5) {
          var target = lastA5 * (1 + devs[4]);
          }
      } else {
        var target = lastA5 * (1 - devs[4]);
      }
    };
    closest = peersMat[4].reduce(function(prev, curr) {
      return(Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev);
    });

    return("Round " + [4 + 1] + ": part B estimate<br><br>" +
    "Your part A estimate of <b>" + lastA5 + "</b> has been recorded.<br><br>" +
    "Now, we show you the part A estimate of an MTurker who completed this task before.<br>" +
    "This previous MTurker saw the same image as you just did. They also saw it for 6 seconds.<br><br>" +
    "Their estimate was <b>" + closest + "</b>.")
    },

  on_finish:function(data) {
    lastB5 = jsPsych.data.get().last(1).values()[0].responses; // don't include "var" if want to access this variable outside function
    lastB5 = lastB5.substr(14,3);  // capture 3-digit numbers
    if (lastB5.slice(2) == '"') {lastB5 = lastB5.substr(0,2);}; // for 2-digit numbers
  },
  // time_limit: xx
};
beast.push(estimateB5);

var beastTimeline = {
  timeline: beast,
};
timeline.push(beastTimeline);

// 12. describe earnings

//
// function getEstimate(round, ests) {
//   var sel = ests[round];
//   return(sel);
// };
//
// var xx = getEstimate(randRound, selectedEstimates);
// console.log(xx)

var selectedEstimate = [];
// var xx = Object.assign({}, selectedEstimates);
// var selectedEstimate = xx[randRound];
// var selectedEstimate = selectedEstimates[randRound];
// console.log(selectedEstimates[randRound]);
// var selectedEstimate = 55;

// console.log(selectedEstimate);

var thisCorr = correctNos[randRound];
// console.log(thisCorr);

var deviation = Math.abs(selectedEstimate - thisCorr);
// console.log(deviation);
var subtraction = Math.min(100, 5*deviation);
// console.log(subtraction);

var points = Math.max(100 - deviation*5, 0);
// console.log(points);

var subtractionT = ["As a consequence, we subtract " + deviation + " x 5 = " + subtraction + " Points."];
if (deviation > 20) {
  var subtractionT = ["As a consequence, we would have subtracted " + deviation + " x 5 Points.<br>" +
    "However, as stated in the instructions, your number of Points cannot become negative, so we subtract 100 Points."]
};

var earnings = {                   // 2nd informant
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 60)},
  is_html: true,
  stimulus: "Your earnings<br><br>Your earnings are calculated as follows.<br><br>" +
    "The computer randomly selected round <b>" + [randRound + 1] + "</b>.<br>" +
    "Then, the computer randomly selected <b>part " + randEstimate + "</b>.<br><br>" +
    "In that case, you estimated how many <b>" + animals[randRound] + "</b> there were in the image.<br>" +
    "Your estimate in that case was <b>" + selectedEstimate + "</b>.<br>" +
    "The actual number of " + animals[randRound] + " in the image was <b>" + thisCorr + "</b>.<br><br>" +
    "This means that your estimate was <b>" + deviation + "</b> off the actual number.<br>" +
    subtractionT + "<br><br>This means that your earnings from this task are 100 - " + subtraction + " = <b>" + points + " Points</b>.<br><br>"
};
// timeline.push(earnings);

// -------------------- NUMERACY ITEMS ---------------------------------- //
// var numInsts = {
//   type: 'html-button-response',
//   button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
//   choices: ['Click here to continue'],
//   on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 3000)},
//   is_html: true,
//   stimulus: "Next, you will answer 7 short numeracy questions.<br><br>" +
//     "You may use pen and paper if you want, but please do NOT use a calculator.<br><br>" +
      // "Do not use a calculator but feel free to use pen and paper."
// };
// timeline.push(numInsts);

var numeracyInstructions = {
  type: 'html-button-response',
  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  choices: ['Click here to continue'],
  on_start: function() {setTimeout(function(){setDisplay("jspsych-btn","")}, 3000)},
  is_html: true,
  stimulus: "You will now see several numeracy problems that vary in difficulty.<br><br>" +
    "Try to answer as many as you can. There is no time limit.<br>" +
    "Do not use a calculator, but you can use pen and paper to work things out.<br><br>"
};
// timeline.push(numeracyInstructions);

// 3 items from Schwartz, Woloshin, Black, & Welch (1997)
var schwartz_coin = {    // correct answer = 500
  type: 'survey-text',
  questions:
    [{prompt: "Imagine that we flip a fair coin 1,000 times.<br>" +
    "What is your best guess about how many times the coin would come up heads in 1,000 flips?",
    placeholder: "_____ times out of 1,000",
    required: true}]
};
// timeline.push(schwartz_coin);

var schwartz_bigbucks = {    // correct answer = 10
  type: 'survey-text',
  questions:
    [{prompt: "In the Big Bucks Lottery, the chance of winning a $10 prize is 1%.<br>" +
    "What is your best guess about how many people would win a $10 prize<br>if 1,000 people " +
    "each buy a single ticket to Big Bucks?",
    placeholder: "_____ people out of 1,000",
    required: true}]
};
// timeline.push(schwartz_bigbucks);

var schwartz_car = {    // correct answer = 0.1%
  type: 'survey-text',
  questions:
    [{prompt: "In Acme Publishing Sweepstakes, the chance of winning a car is 1 in 1,000.<br>" +
    "What percent of tickets to Acme Publishing Sweepstakes win a car?",
    placeholder: "_____ %",
    required: true}]
};
// timeline.push(schwartz_car);

// 4 items from Berlin Numeracy Test (Cokely, Galesic, Schulz, Ghazal, & Garcia-Retamero (2012))
var bnt_5die = {      // correct answer = 30/50 throws
  type: 'survey-text',
  questions:
    [{prompt: "Imagine we are throwing a five-sided die 50 times.<br>" +
    "On average, out of these 50 throws how many times would this five-sided die show an odd number (1, 3, or 5)?",
    placeholder: "_____ out of 50 throws",
    required: true}]
};
// timeline.push(bnt_5die);

var bnt_choir = {      // correct answer = 25%
  type: 'survey-text',
  questions:
    [{prompt: "Out of 1,000 people in a small town 500 are members of a choir.<br>" +
    "Out of these 500 members in the choir 100 are men.<br>" +
    "Out of the 500 inhabitants that are not in the choir 300 are men.<br>" +
    "What is the probability that a randomly drawn man is a member of the choir?",
    placeholder: "Please indicate the probability in percent _____ %",
    required: true}]
};
// timeline.push(bnt_choir);

var bnt_6die = {       // correct answer = 20/70 throws
  type: 'survey-text',
  questions:
    [{prompt: "Imagine we are throwing a loaded die (6 sides).<br>" +
    "The probability that the die shows a 6 is twice as high as the probability of each of the other numbers.<br>" +
    "On average, out of these 70 throws, how many times would the die show the number 6?<br>",
    placeholder: "_____ out of 70 throws",
    required: true}]
};
// timeline.push(bnt_6die);

var bnt_mushrooms = {       // correct answer = 50%
  type: 'survey-text',
  questions:
    [{prompt: "In a forest, 20% of mushrooms are red, 50% brown and 30% white.<br>" +
    "A red mushroom is poisonous with a probability of 20%.<br>" +
    "A mushroom that is not red is poisonous with a probability of 5%.<br>" +
    "What is the probability that a poisonous mushroom in the forest is red?<br>",
    placeholder: "_____ %",
    required: true}]
};
// timeline.push(bnt_mushrooms);

var calccheck = {
  type: "survey-multi-choice",
  questions: [{prompt:"Did you use a calculator for any of the 7 numeracy questions?<br>" +
                "(Please be honest, your answer here does not affect payment)",
              options: ["Yes", "No"],
              required:true}],
};
// timeline.push(calccheck);

// --------------------- COGNITIVE REFLECTION ---------------------------- //
var crts = {
  timeline: [{
      type: 'survey-text',
      questions:
        [{prompt: jsPsych.timelineVariable('crtPrompt'),
          placeholder: jsPsych.timelineVariable('crtPlaceholder'),
          required: true}],
    }],
    timeline_variables: [
      {crtPrompt: "If you're running a race and you pass the person " +
      "in second place, what place are you in?",
        crtPlaceholder: "_____ place"},             // intuitive = 1st, correct = 2nd
      {crtPrompt: "A farmer had 15 sheep and all but 8 died. How many are left?",
        crtPlaceholder: "_____ sheep left"},        // intuitive = 7, correct = 8
      {crtPrompt: "Emily's father had three daughters." +
        "The first two are named April and May.<br>What is the third daughter's name?",
        crtPlaceholder: "Third daughter's name"},   // intuitive = June, correct = Emily
      {crtPrompt: "How many cubic feet of dirt are there in a hole that is " +
        "3' deep x 3' wide x 3' long?",
        crtPlaceholder: "_____ cubic feet of dirt"},// intuitive = 27, correct = none
      {crtPrompt: "A bat and a ball cost $1.10 in total.The bat costs $1.00 more than the ball.<br>" +
      "How much does the ball cost?",
        crtPlaceholder: "_____ cents"},            // intuitive = 10, correct = 5
      {crtPrompt: "If it takes 5 machines 5 minutes to make 5 widgets,<br>" +
        "how long would it take 100 machines to make 100 widgets?",
        crtPlaceholder: "_____ minutes"},           // intuitive = 100, correct = 5
      {crtPrompt: "In a lake, there is a patch of lily pads. Every day, the patch doubles in size.<br>" +
        "If it takes 48 days for the patch to cover the entire lake,<br>how long would it take for the patch to cover half of the lake?",
        crtPlaceholder: "_____ days"},             // intuitive = 24, correct = 47
    ],
    randomize_order: true
};
// timeline.push(crts);

// ----------------- finish with attention check question ---------------- //
var attnCheck = {
  type: 'survey-text',
  questions: [{prompt: ""}],
  preamble: ["<div class = 'center-content'><img src = img/attnCheck2.JPG></img>"]
};
// timeline.push(attnCheck);

// start by running the "welcome" //
welcome.run()

  </script>
</html>
